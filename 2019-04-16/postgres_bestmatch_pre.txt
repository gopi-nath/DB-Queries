CREATE MATERIALIZED VIEW provider_information_speciality_scores_temp AS WITH
unnested_specialities AS (
    SELECT
        *,
        UNNEST(speciality_ids) AS speciality_id,
        speciality_ids AS all_specialities
    FROM provider_information_v3
)
SELECT
    us.provider_core_id,
    us.provider_product_id,
    us.npi,
    us.address_confidence,
    us.degree,
    us.speciality_id,
    us.all_specialities,
    us.zip,
    us.latitude,
    us.longitude,
    us.cbsa_code,
    us.service_area_evive_network_ids,
    us.product_id_evive_network_ids,
    us.name_id,
    us.first_name,
    us.middle_name,
    us.last_name,
    us.facility_name,
    us.gender,
    us.language_ids,
    us.combined_score,
    sd.name AS speciality_name,
    us.type_ids,
    us.type_names,
    sds.care_score,
    sds.care_score_raw,
    us.is_facility,
    us.address_id,
    us.address,
    us.city,
    us.state
FROM unnested_specialities us
INNER JOIN speciality_domain sd ON (us.speciality_id = sd.id)
LEFT JOIN speciality_docscore sds ON (sds.npi = us.npi AND sds.cbsa = us.cbsa_code AND sds.speciality_id = us.speciality_id)
;

BEGIN;
DROP MATERIALIZED VIEW provider_information_speciality_scores;
ALTER MATERIALIZED VIEW provider_information_speciality_scores_temp RENAME TO provider_information_speciality_scores;
COMMIT;
